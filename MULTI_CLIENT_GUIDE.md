# Multi-Client Management Guide

## Overview

The AI KPI Dashboard now supports managing data for multiple clients. Each client can have separate chat history data and KPIs can be viewed per client or across all clients.

## Features

### Client Management
- Create clients with custom names, descriptions, and colors
- Edit client information
- Delete clients (also deletes all associated data)
- View all clients in a list

### Data Upload
- Select a client before uploading CSV/JSON data
- Each uploaded file is associated with a specific client
- Client validation ensures data integrity

### Dashboard Filtering
- View KPIs for all clients combined
- Filter KPIs by specific client
- Real-time updates when changing client selection

## User Workflow

### 1. Create a Client

Visit the Upload page ([/upload](./app/upload/page.tsx)):

1. Click "Add Client" button in the Client Management section
2. Enter client name (required)
3. Optionally add description
4. Choose a color (random color generated by default)
5. Click "Create Client"

### 2. Upload Data for a Client

On the Upload page:

1. Select a client from the dropdown (required)
2. Drag and drop or click to select CSV/JSON file
3. Click "Upload File"
4. Data will be associated with the selected client

### 3. View Client-Specific KPIs

On the Dashboard page ([/](./app/page.tsx)):

1. Use the client selector dropdown at the top
2. Select "All Clients" to see aggregated metrics
3. Select a specific client to see only their KPIs
4. KPIs automatically refresh when selection changes

## Technical Implementation

### Backend Architecture

#### Data Store ([lib/data-store.ts](./lib/data-store.ts))

New Client interface:
```typescript
interface Client {
  id: string;
  name: string;
  description?: string;
  color?: string;
  createdAt: Date;
}
```

Client CRUD methods:
- `addClient(client)` - Create new client
- `getClient(id)` - Get client by ID
- `getAllClients()` - List all clients
- `updateClient(id, updates)` - Update client info
- `deleteClient(id)` - Delete client and associated data

All data retrieval methods now support optional `clientId` parameter:
- `getAllConversations(clientId?)`
- `getAllMessages(clientId?)`
- `getMessagesByDateRange(startDate?, endDate?, clientId?)`

#### API Endpoints

**Client Management API** ([app/api/clients/route.ts](./app/api/clients/route.ts)):
- `GET /api/clients` - Fetch all clients
- `POST /api/clients` - Create new client (requires name)
- `PATCH /api/clients` - Update client (requires id)
- `DELETE /api/clients?id={id}` - Delete client

**Upload API** ([app/api/upload/route.ts](./app/api/upload/route.ts)):
- Now requires `clientId` in FormData
- Validates client exists before processing
- Associates all records with the client

**KPI API** ([app/api/kpis/route.ts](./app/api/kpis/route.ts)):
- Supports optional `clientId` query parameter
- Returns filtered KPIs when clientId provided
- Returns all clients' data when no clientId specified

#### KPI Calculator ([lib/kpi-calculator.ts](./lib/kpi-calculator.ts))
```typescript
calculateKPIs(dateRange?: DateRange, clientId?: string): Promise<KPIData>
```

### Frontend Architecture

#### Components

**ClientManager** ([components/ClientManager.tsx](./components/ClientManager.tsx)):
- Full CRUD UI for clients
- Form for creating/editing clients
- List view with edit and delete actions
- Color picker for client branding

**ClientSelector** ([components/ClientSelector.tsx](./components/ClientSelector.tsx)):
- Dropdown component for selecting clients
- Shows client color indicator
- Supports "All Clients" option (for dashboard)
- Required mode (for upload page)

**FileUploader** ([components/FileUploader.tsx](./components/FileUploader.tsx)):
- Updated to accept `clientId` prop
- Validates client selected before upload
- Sends clientId with file upload

#### Pages

**Upload Page** ([app/upload/page.tsx](./app/upload/page.tsx)):
- Integrated ClientManager component
- ClientSelector with required mode
- FileUploader with client validation

**Dashboard Page** ([app/page.tsx](./app/page.tsx)):
- ClientSelector with "All Clients" option
- Auto-refresh KPIs when client selection changes
- Filtered metrics display

## Data Flow

```
1. User creates client → POST /api/clients → DataStore.addClient()
2. User uploads CSV → POST /api/upload (with clientId) → DataStore.addOrUpdateConversation()
3. User views dashboard → GET /api/kpis?clientId=xxx → calculateKPIs(clientId)
```

## API Examples

### Create Client
```bash
curl -X POST http://localhost:3000/api/clients \
  -H "Content-Type: application/json" \
  -d '{"name": "Acme Corp", "description": "Main client", "color": "#FF5733"}'
```

### Upload Data for Client
```bash
curl -X POST http://localhost:3000/api/upload \
  -F "file=@chat_history.csv" \
  -F "clientId=client_abc123"
```

### Get KPIs for Specific Client
```bash
curl http://localhost:3000/api/kpis?clientId=client_abc123
```

### Get KPIs for All Clients
```bash
curl http://localhost:3000/api/kpis
```

## Deployment Considerations

### In-Memory Data Warning
Remember that this application uses in-memory storage. When Railway restarts:
- All clients are lost
- All uploaded data is lost
- Users must re-create clients and re-upload data

### Data Segregation
- Each client's data is completely isolated
- Deleting a client also deletes all associated:
  - Conversations
  - Messages
  - Upload records

### Performance
- Client filtering is performed in-memory
- Very fast for datasets up to 100,000 messages
- No database queries or indexes needed

## Future Enhancements

Potential improvements (would require database):
- Client data persistence
- Multi-user authentication
- Client access control
- Historical data retention
- Export client-specific reports
- Client usage analytics
- Scheduled data imports

## Support

For issues specific to multi-client functionality:
1. Verify client was created successfully
2. Check Railway logs for client association errors
3. Confirm clientId is being sent with uploads
4. Validate KPI API includes clientId parameter

---

**Version**: 2.0
**Last Updated**: 2026-01-28
**Commit**: 3c7ff1b
